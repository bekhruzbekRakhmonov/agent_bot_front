<script>
const API_URL = 'http://localhost:5000/api';
const loginForm = document.getElementById('loginForm');
const chatInterface = document.getElementById('chatInterface');
const agentInfo = document.getElementById('agentInfo');
const agentName = document.getElementById('agentName');
const loginButton = document.getElementById('loginButton');
const logoutButton = document.getElementById('logoutButton');
const chatContainer = document.getElementById('chatContainer');
const emptyStateContainer = document.getElementById('emptyStateContainer');
const userInput = document.getElementById('userInput');
const sendButton = document.getElementById('sendMessage');
const typingIndicator = document.getElementById('typingIndicator');

let token = localStorage.getItem('token');
let conversationContext = {};

function showChatInterface(name) {
    loginForm.classList.add('hidden');
    chatInterface.classList.remove('hidden');
    agentInfo.classList.remove('hidden');
    agentName.textContent = `Agent: ${name}`;
    loadChatHistory();
}

function showLoginForm() {
    loginForm.classList.remove('hidden');
    chatInterface.classList.add('hidden');
    agentInfo.classList.add('hidden');
}

function showEmptyState() {
    chatContainer.classList.add('hidden');
    emptyStateContainer.classList.remove('hidden');
}

function hideEmptyState() {
    chatContainer.classList.remove('hidden');
    emptyStateContainer.classList.add('hidden');
}

async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    try {
        const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
            token = data.token;
            localStorage.setItem('token', token);
            showChatInterface(data.agent_name);
        } else {
            alert(data.message || 'Login failed');
        }
    } catch (error) {
        console.error('Login error:', error);
        alert('An error occurred during login');
    }
}

function logout() {
    localStorage.removeItem('token');
    token = null;
    conversationContext = {};
    chatContainer.innerHTML = '';
    showLoginForm();
}

function addMessage(sender, content, isHistory = false) {
    hideEmptyState();
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender === 'You' ? 'user-message ml-auto' : 'bot-message'} p-3 rounded-lg mb-2`;
    
    const senderSpan = document.createElement('span');
    senderSpan.className = 'font-bold';
    senderSpan.textContent = `${sender}:`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content mt-1';
    contentDiv.innerHTML = marked.parse(content);
    
    messageDiv.appendChild(senderSpan);
    messageDiv.appendChild(contentDiv);
    
    chatContainer.appendChild(messageDiv);
    if (!isHistory) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

async function loadChatHistory() {
    try {
        const response = await fetch(`${API_URL}/messages`, {
            headers: { 'Authorization': token }
        });
        const messages = await response.json();
        
        if (messages.length === 0) {
            showEmptyState();
        } else {
            hideEmptyState();
            chatContainer.innerHTML = '';
            messages.forEach(msg => {
                addMessage(msg.sender === 'agent' ? 'You' : 'Assistant', msg.content, true);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    } catch (error) {
        console.error('Error loading chat history:', error);
        showEmptyState();
    }
}

async function sendMessage(message = null) {
    const messageToSend = message || userInput.value.trim();
    if (messageToSend) {
        addMessage('You', messageToSend);
        userInput.value = '';
        typingIndicator.classList.remove('hidden');

        try {
            const response = await fetch(`${API_URL}/chatbot`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': token
                },
                body: JSON.stringify({ message: messageToSend, context: conversationContext })
            });
            const data = await response.json();
            typingIndicator.classList.add('hidden');
            addMessage('Assistant', data.response);
            conversationContext = data.context;

            if (data.actions) {
                handleActions(data.actions);
            }
        } catch (error) {
            console.error('Error sending message:', error);
            typingIndicator.classList.add('hidden');
            addMessage('Assistant', 'Sorry, I encountered an error. Please try again.');
        }
    }
}

function handleActions(actions) {
    console.log('Actions to handle:', actions);
}

loginButton.addEventListener('click', login);
logoutButton.addEventListener('click', logout);
sendButton.addEventListener('click', () => sendMessage());
userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

document.querySelectorAll('.quick-action, .suggestion').forEach(button => {
    button.addEventListener('click', () => {
        sendMessage(button.textContent);
    });
});

if (token) {
    fetch(`${API_URL}/agents/me`, {
        headers: { 'Authorization': token }
    })
    .then(response => response.json())
    .then(data => {
        if (data.name) {
            showChatInterface(data.name);
        } else {
            showLoginForm();
        }
    })
    .catch(error => {
        console.error('Error verifying token:', error);
        showLoginForm();
    });
} else {
    showLoginForm();
}
</script>